# Identity Columns Example

This example demonstrates PostgreSQL Identity Columns in Pebble ORM.

## What are Identity Columns?

Identity columns use the `GENERATED AS IDENTITY` syntax for auto-incrementing IDs. They're the SQL standard (SQL:2003) and recommended by PostgreSQL.

## Project Structure

```
identity-columns/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ identity-example/
â”‚       â””â”€â”€ main.go          # Example program
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ db.go            # Database connection
â”‚   â””â”€â”€ models/
â”‚       â”œâ”€â”€ models.go        # Model definitions
â”‚       â””â”€â”€ registry.go      # Model registration
â”œâ”€â”€ go.mod
â””â”€â”€ README.md
```

## Models

### Product (GENERATED ALWAYS AS IDENTITY)

**Recommended** - Strict protection, IDs always auto-generated.

```go
type Product struct {
    ID          int64     `po:"id,primaryKey,bigint,identity"`
    Name        string    `po:"name,varchar(255),notNull"`
    Description string    `po:"description,text"`
    Price       float64   `po:"price,numeric(10,2),notNull"`
    InStock     bool      `po:"in_stock,boolean,default(true),notNull"`
    CreatedAt   time.Time `po:"created_at,timestamptz,default(NOW()),notNull"`
}
```

**Generated SQL:**

```sql
CREATE TABLE IF NOT EXISTS products (
    id bigint GENERATED ALWAYS AS IDENTITY,
    name varchar(255) NOT NULL,
    description text,
    price numeric(10,2) NOT NULL,
    in_stock boolean NOT NULL DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT NOW(),
    CONSTRAINT products_pkey PRIMARY KEY (id)
);
```

### Order (GENERATED BY DEFAULT AS IDENTITY)

**Flexible** - Auto-generated by default, manual override allowed.

```go
type Order struct {
    ID          int       `po:"id,primaryKey,integer,identityByDefault"`
    OrderNumber string    `po:"order_number,varchar(50),unique,notNull"`
    ProductID   int64     `po:"product_id,bigint,notNull"`
    Quantity    int       `po:"quantity,integer,notNull"`
    TotalPrice  float64   `po:"total_price,numeric(10,2),notNull"`
    Status      string    `po:"status,varchar(20),default('pending'),notNull"`
    CreatedAt   time.Time `po:"created_at,timestamptz,default(NOW()),notNull"`
}
```

**Generated SQL:**

```sql
CREATE TABLE IF NOT EXISTS orders (
    id integer GENERATED BY DEFAULT AS IDENTITY,
    order_number varchar(50) NOT NULL UNIQUE,
    product_id bigint NOT NULL,
    quantity integer NOT NULL,
    total_price numeric(10,2) NOT NULL,
    status varchar(20) NOT NULL DEFAULT 'pending',
    created_at timestamptz NOT NULL DEFAULT NOW(),
    CONSTRAINT orders_pkey PRIMARY KEY (id)
);
```

## Setup

### Prerequisites

- Go 1.21+
- PostgreSQL 10+
- `pebble` CLI (`go install ./cmd/pebble`)

### 1. Install Dependencies

```bash
cd examples/identity-columns
go mod tidy
```

### 2. Set Database URL (Optional)

```bash
export DATABASE_URL="postgres://user:pass@localhost:5432/dbname?sslmode=disable"
```

### 3. Generate Migrations

```bash
pebble generate --name init_identity_tables \
  --models ./internal/models \
  --verbose
```

### 4. Apply Migrations

```bash
pebble migrate up --all --db $DATABASE_URL
```

### 5. Run the Example

```bash
go run ./cmd/identity-example
```

## Example Output

```
=== Pebble ORM Identity Columns Example ===

--- Example 1: INSERT with GENERATED ALWAYS ---
âœ… Inserted product: ID=1, Name=Premium Widget, Price=49.99

--- Example 2: INSERT with GENERATED BY DEFAULT ---
âœ… Inserted order: ID=1, OrderNumber=ORD-2025-001, Total=99.98

--- Example 3: SELECT Products ---
Found 1 product(s):
  - ID=1: Premium Widget ($49.99)

--- Example 4: SELECT Orders ---
Found 1 order(s):
  - ID=1: ORD-2025-001 (Qty: 2, Total: $99.98)

--- Example 5: UPDATE Order ---
âœ… Updated 1 order(s) to 'shipped' status

--- Example 6: COUNT ---
âœ… Total in-stock products: 1

=== Examples Complete ===

ðŸ’¡ Identity Types Used:
   â€¢ Product.ID: GENERATED ALWAYS AS IDENTITY (strict, recommended)
   â€¢ Order.ID: GENERATED BY DEFAULT AS IDENTITY (flexible)
```

## Tag Options

| Tag                 | SQL Output                         | Use Case             |
| ------------------- | ---------------------------------- | -------------------- |
| `identity`          | `GENERATED ALWAYS AS IDENTITY`     | **Default choice**   |
| `identityAlways`    | `GENERATED ALWAYS AS IDENTITY`     | Same as `identity`   |
| `identityByDefault` | `GENERATED BY DEFAULT AS IDENTITY` | Need manual override |

### Examples

```go
// Recommended - Strict
ID int64 `po:"id,primaryKey,bigint,identity"`

// Flexible - Allow manual IDs
ID int `po:"id,primaryKey,integer,identityByDefault"`
```

## Inserting Data

### With GENERATED ALWAYS

```go
// âœ… ID auto-generated
product := models.Product{
    Name:  "Widget",
    Price: 19.99,
}
inserted, _ := builder.Insert[models.Product](qb).
    Values(product).
    Returning("*").
    ExecReturning(ctx)
```

### With GENERATED BY DEFAULT

```go
// âœ… Auto-generated
order := models.Order{OrderNumber: "ORD-001"}

// âœ… Or manual (when needed)
orderWithID := models.Order{
    ID:          999,
    OrderNumber: "ORD-002",
}
```

## Best Practices

1. **Use `identity` by default** - SQL standard, modern
2. **Use `identityAlways`** - Strict protection recommended
3. **Use `identityByDefault`** only when manual override needed
4. **Use `bigint`** for high-volume tables

## When to Use Each

| Scenario                   | Choice              |
| -------------------------- | ------------------- |
| New table                  | âœ… `identity`       |
| Need strict ID control     | âœ… `identityAlways` |
| Need occasional manual IDs | `identityByDefault` |
| Data migration with IDs    | `identityByDefault` |

## Why Identity Columns?

âœ… **SQL Standard** - Works across PostgreSQL, Oracle, SQL Server  
âœ… **Better Safety** - ALWAYS prevents accidental IDs  
âœ… **Cleaner** - No implicit sequences  
âœ… **PostgreSQL Recommended** - Modern best practice

## Learn More

- [Pebble ORM Docs](../../README.md)
- [PostgreSQL Identity Columns](https://www.postgresql.org/docs/current/ddl-identity-columns.html)
- [Basic Example](../basic/)
- [Migrations Example](../migrations/)
