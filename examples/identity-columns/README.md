# Identity Columns Example

This example demonstrates PostgreSQL Identity Columns support in Pebble ORM.

## What are Identity Columns?

Identity columns are the **SQL standard way** (SQL:2003) to create auto-incrementing columns, introduced in PostgreSQL 10. They are **recommended over SERIAL** for new projects.

### Serial vs Identity

| Feature    | SERIAL              | IDENTITY                     |
| ---------- | ------------------- | ---------------------------- |
| Standard   | PostgreSQL-specific | ‚úÖ SQL Standard              |
| Syntax     | `serial` type       | `GENERATED AS IDENTITY`      |
| Protection | Can be overridden   | `ALWAYS` prevents overriding |
| Modern     | Legacy              | ‚úÖ **Recommended**           |

## Project Structure

```
identity-columns/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ identity-example/
‚îÇ       ‚îî‚îÄ‚îÄ main.go          # Example program
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db.go            # Database connection
‚îÇ   ‚îî‚îÄ‚îÄ models/
‚îÇ       ‚îú‚îÄ‚îÄ models.go        # Model definitions with identity columns
‚îÇ       ‚îî‚îÄ‚îÄ registry.go      # Model registration
‚îú‚îÄ‚îÄ go.mod
‚îî‚îÄ‚îÄ README.md               # This file
```

## Models

### Product (GENERATED ALWAYS AS IDENTITY)

**Recommended for most cases** - Strict protection against manual ID insertion.

```go
type Product struct {
    ID          int64     `po:"id,primaryKey,bigint,identity"`
    Name        string    `po:"name,varchar(255),notNull"`
    Description string    `po:"description,text"`
    Price       float64   `po:"price,numeric(10,2),notNull"`
    InStock     bool      `po:"in_stock,boolean,default(true),notNull"`
    CreatedAt   time.Time `po:"created_at,timestamptz,default(NOW()),notNull"`
}
```

**Generated SQL:**

```sql
CREATE TABLE IF NOT EXISTS products (
    id bigint GENERATED ALWAYS AS IDENTITY,
    name varchar(255) NOT NULL,
    description text,
    price numeric(10,2) NOT NULL,
    in_stock boolean NOT NULL DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT NOW(),
    CONSTRAINT products_pkey PRIMARY KEY (id)
);
```

### Order (GENERATED BY DEFAULT AS IDENTITY)

**Flexible option** - Generated by default, but allows manual override.

```go
type Order struct {
    ID          int       `po:"id,primaryKey,integer,identityByDefault"`
    OrderNumber string    `po:"order_number,varchar(50),unique,notNull"`
    ProductID   int64     `po:"product_id,bigint,notNull"`
    Quantity    int       `po:"quantity,integer,notNull"`
    TotalPrice  float64   `po:"total_price,numeric(10,2),notNull"`
    Status      string    `po:"status,varchar(20),default('pending'),notNull"`
    CreatedAt   time.Time `po:"created_at,timestamptz,default(NOW()),notNull"`
}
```

**Generated SQL:**

```sql
CREATE TABLE IF NOT EXISTS orders (
    id integer GENERATED BY DEFAULT AS IDENTITY,
    order_number varchar(50) NOT NULL UNIQUE,
    product_id bigint NOT NULL,
    quantity integer NOT NULL,
    total_price numeric(10,2) NOT NULL,
    status varchar(20) NOT NULL DEFAULT 'pending',
    created_at timestamptz NOT NULL DEFAULT NOW(),
    CONSTRAINT orders_pkey PRIMARY KEY (id)
);
```

### Customer (Legacy SERIAL)

**Backward compatibility** - SERIAL still fully supported.

```go
type Customer struct {
    ID        int       `po:"id,primaryKey,serial"`
    Email     string    `po:"email,varchar(320),unique,notNull"`
    Name      string    `po:"name,varchar(255),notNull"`
    CreatedAt time.Time `po:"created_at,timestamptz,default(NOW()),notNull"`
}
```

## Setup

### Prerequisites

- Go 1.21+
- PostgreSQL 10+ (for identity columns)
- `pebble` CLI installed (`go install ./cmd/pebble`)

### 1. Install Dependencies

```bash
cd examples/identity-columns
go mod tidy
```

### 2. Set Database URL (Optional)

```bash
export DATABASE_URL="postgres://user:pass@localhost:5432/dbname?sslmode=disable"
```

Default: `postgres://postgres:postgres@localhost:5432/pebble_test?sslmode=disable`

### 3. Generate Migrations

```bash
pebble generate --name init_identity_tables \
  --models ./internal/models \
  --verbose
```

This generates:

```
migrations/YYYYMMDDHHMMSS_init_identity_tables.up.sql
migrations/YYYYMMDDHHMMSS_init_identity_tables.down.sql
```

**Example generated SQL:**

```sql
CREATE TABLE IF NOT EXISTS products (
    id bigint GENERATED ALWAYS AS IDENTITY,
    name varchar(255) NOT NULL,
    ...
);

CREATE TABLE IF NOT EXISTS orders (
    id integer GENERATED BY DEFAULT AS IDENTITY,
    order_number varchar(50) NOT NULL UNIQUE,
    ...
);

CREATE TABLE IF NOT EXISTS customers (
    id serial NOT NULL,
    email varchar(320) NOT NULL UNIQUE,
    ...
);
```

### 4. Apply Migrations

```bash
pebble migrate up --all --db $DATABASE_URL
```

### 5. Run the Example

```bash
go run ./cmd/identity-example
```

## Example Output

```
=== Pebble ORM Identity Columns Example ===

--- Example 1: INSERT Product (GENERATED ALWAYS) ---
‚úÖ Inserted product: ID=1, Name=Premium Widget, Price=49.99

--- Example 2: INSERT Order (GENERATED BY DEFAULT) ---
‚úÖ Inserted order: ID=1, OrderNumber=ORD-2025-001, Total=99.98

--- Example 3: INSERT Customer (Legacy SERIAL) ---
‚úÖ Inserted customer: ID=1, Email=john.doe@example.com

--- Example 4: SELECT Products ---
Found 1 product(s):
  - ID=1: Premium Widget ($49.99)

--- Example 5: SELECT Orders ---
Found 1 order(s):
  - ID=1: ORD-2025-001 (Status: pending, Total: $99.98)

--- Example 6: UPDATE Order Status ---
‚úÖ Updated 1 order(s) to 'shipped' status

--- Example 7: COUNT Products ---
‚úÖ Total in-stock products: 1

=== Examples Complete ===

üí° Key Differences:
   ‚Ä¢ Product.ID: GENERATED ALWAYS AS IDENTITY (strict, best practice)
   ‚Ä¢ Order.ID: GENERATED BY DEFAULT AS IDENTITY (flexible)
   ‚Ä¢ Customer.ID: SERIAL (legacy, still supported)
```

## Tag Options

### Identity Column Tags

| Tag                 | SQL Output                         | Use Case                            |
| ------------------- | ---------------------------------- | ----------------------------------- |
| `identity`          | `GENERATED ALWAYS AS IDENTITY`     | **Recommended** - Strict protection |
| `identityAlways`    | `GENERATED ALWAYS AS IDENTITY`     | Same as `identity`                  |
| `identityByDefault` | `GENERATED BY DEFAULT AS IDENTITY` | Need manual override flexibility    |
| `serial`            | `serial NOT NULL`                  | Legacy compatibility                |

### Example

```go
type Example struct {
    // Recommended - Strict
    ID1 int64 `po:"id1,primaryKey,bigint,identity"`

    // Flexible - Allow override
    ID2 int `po:"id2,primaryKey,integer,identityByDefault"`

    // Legacy - Still works
    ID3 int `po:"id3,primaryKey,serial"`
}
```

## Inserting Data

### With GENERATED ALWAYS

```go
// ‚úÖ This works - ID auto-generated
product := models.Product{
    Name:  "Widget",
    Price: 19.99,
}
inserted, _ := builder.Insert[models.Product](qb).
    Values(product).
    Returning("*").
    ExecReturning(ctx)
// inserted[0].ID will be auto-generated (e.g., 1, 2, 3...)

// ‚ùå Manual ID requires special SQL (not supported by builder yet)
// Would need: INSERT ... OVERRIDING SYSTEM VALUE
```

### With GENERATED BY DEFAULT

```go
// ‚úÖ Auto-generated ID
order := models.Order{OrderNumber: "ORD-001"}

// ‚úÖ Or manual ID (no special syntax needed)
orderWithID := models.Order{
    ID:          999,
    OrderNumber: "ORD-002",
}
```

## Best Practices

1. **Use `identity` for new tables** - Modern, SQL standard, future-proof
2. **Use `identityAlways`** by default - Prevents accidental manual IDs
3. **Use `identityByDefault`** only when needed - E.g., data migrations, special cases
4. **Keep `serial` for existing tables** - No need to migrate unless you want to
5. **Use `bigint` for high-volume tables** - Prevents overflow

## Why Identity over SERIAL?

### Identity Advantages

‚úÖ **SQL Standard** - Works across PostgreSQL, Oracle, SQL Server  
‚úÖ **Better Safety** - `ALWAYS` prevents manual IDs  
‚úÖ **Cleaner** - No implicit sequence creation  
‚úÖ **Control** - More options for sequence management  
‚úÖ **PostgreSQL Recommended** - Official docs recommend over SERIAL

### When to Use Each

| Use Case                          | Recommended                  |
| --------------------------------- | ---------------------------- |
| New project                       | ‚úÖ **Identity**              |
| Need strict ID control            | ‚úÖ **Identity (ALWAYS)**     |
| Need manual override occasionally | ‚úÖ **Identity (BY DEFAULT)** |
| Existing project with SERIAL      | Keep SERIAL (works fine)     |
| Legacy database migration         | ‚úÖ **Identity (BY DEFAULT)** |

## Learn More

- **Pebble ORM Docs**: [README.md](../../README.md)
- **PostgreSQL Docs**: [Identity Columns](https://www.postgresql.org/docs/current/ddl-identity-columns.html)
- **Other Examples**:
  - [Basic Example](../basic/) - Getting started
  - [Migrations Example](../migrations/) - Schema migrations

## License

Same as Pebble ORM - see [LICENSE](../../LICENSE)
