# Identity Columns Example

This example demonstrates PostgreSQL Identity Columns support in Pebble ORM.

## What are Identity Columns?

Identity columns are the SQL standard way (SQL:2003) to create auto-incrementing columns, introduced in PostgreSQL 10. They are **recommended over SERIAL** for new projects.

### Serial vs Identity

| Feature     | SERIAL              | IDENTITY                     |
| ----------- | ------------------- | ---------------------------- |
| Standard    | PostgreSQL-specific | SQL Standard                 |
| Syntax      | `serial` type       | `GENERATED AS IDENTITY`      |
| Protection  | Can be overridden   | `ALWAYS` prevents overriding |
| Recommended | Legacy              | âœ… **Modern best practice**  |

## Usage

### Tag Syntax

```go
type User struct {
    // GENERATED ALWAYS AS IDENTITY
    ID int64 `po:"id,primaryKey,bigint,identity"`

    // Or explicitly:
    ID int64 `po:"id,primaryKey,bigint,identityAlways"`

    // GENERATED BY DEFAULT AS IDENTITY (allows manual override)
    ID int64 `po:"id,primaryKey,integer,identityByDefault"`
}
```

### Generation Types

**`identityAlways` (or just `identity`)**:

- Values are **always** generated automatically
- Manual INSERT requires `OVERRIDING SYSTEM VALUE`
- Provides maximum protection against accidental manual IDs
- **Recommended for most cases**

**`identityByDefault`**:

- Values generated by default
- User can provide explicit values
- Similar to how SERIAL works
- Use when you need flexibility to insert specific IDs

## Example Models

### ALWAYS Generation (Strict)

```go
package models

type Product struct {
    ID          int64  `po:"id,primaryKey,bigint,identity"`
    Name        string `po:"name,varchar(255),notNull"`
    Description string `po:"description,text"`
}
```

Generated SQL:

```sql
CREATE TABLE IF NOT EXISTS products (
    id bigint GENERATED ALWAYS AS IDENTITY,
    name varchar(255) NOT NULL,
    description text,
    CONSTRAINT products_pkey PRIMARY KEY (id)
);
```

### BY DEFAULT Generation (Flexible)

```go
type Order struct {
    ID          int    `po:"id,primaryKey,integer,identityByDefault"`
    OrderNumber string `po:"order_number,varchar(50),notNull"`
    Total       int    `po:"total,integer,notNull"`
}
```

Generated SQL:

```sql
CREATE TABLE IF NOT EXISTS orders (
    id integer GENERATED BY DEFAULT AS IDENTITY,
    order_number varchar(50) NOT NULL,
    total integer NOT NULL,
    CONSTRAINT orders_pkey PRIMARY KEY (id)
);
```

## Inserting Data

### With ALWAYS

```go
// This works - ID auto-generated
product := Product{
    Name:        "Widget",
    Description: "A great widget",
}
insertedProducts, _ := builder.Insert[Product](qb).
    Values(product).
    Returning("*").
    ExecReturning(ctx)
```

To insert with explicit ID (ALWAYS columns):

```sql
-- SQL required:
INSERT INTO products (id, name)
OVERRIDING SYSTEM VALUE
VALUES (123, 'Widget');
```

### With BY DEFAULT

```go
// Auto-generated ID
order := Order{OrderNumber: "ORD-001", Total: 100}

// Or explicit ID (no special syntax needed)
orderWithID := Order{ID: 999, OrderNumber: "ORD-002", Total: 200}
```

## Migration Generation

```bash
# Generate migration
pebble generate --name add_products --models ./models

# Generated migration will use GENERATED AS IDENTITY syntax
```

## Backward Compatibility

**Both SERIAL and IDENTITY are supported:**

```go
// Legacy SERIAL (still works)
type OldModel struct {
    ID int `po:"id,primaryKey,serial"`
}

// Modern IDENTITY (recommended)
type NewModel struct {
    ID int `po:"id,primaryKey,integer,identity"`
}
```

## Best Practices

1. **Use `identity` for new projects** - It's the SQL standard and future-proof
2. **Use `identityAlways` by default** - Prevents accidental manual ID insertion
3. **Use `identityByDefault`** only when you need to insert specific IDs
4. **Keep SERIAL** for existing tables (no need to migrate immediately)

## References

- [PostgreSQL Documentation: Identity Columns](https://www.postgresql.org/docs/current/ddl-identity-columns.html)
- [SQL Standard: SQL:2003](https://en.wikipedia.org/wiki/SQL:2003)
