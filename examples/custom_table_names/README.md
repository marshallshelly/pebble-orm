# Custom Table Names Example

This example demonstrates how to use comment directives to specify custom table names in Pebble ORM.

## Feature

Instead of relying on automatic `snake_case` conversion of struct names, you can now specify custom table names using a comment directive:

```go
// table_name: custom_users_table
type User struct {
    ID    int    `po:"id,primaryKey,serial"`
    Name  string `po:"name,varchar(100),notNull"`
    Email string `po:"email,varchar(255),unique,notNull"`
}
```

## Comment Directive Format

```go
// table_name: your_custom_name
type YourStruct struct {
    // ...
}
```

**Rules:**

- Must be a line comment (`//`) directly above the struct declaration
- Format: `// table_name: table_name_value`
- Whitespace around the colon is optional
- Table name must be a valid PostgreSQL identifier (alphanumeric + underscores)

## Examples

### Custom Table Name

```go
// table_name: custom_users_table
type User struct {
    ID int `po:"id,primaryKey,serial"`
}
// Table name in database: "custom_users_table"
```

### Default Snake Case

```go
type UserProfile struct {
    ID int `po:"id,primaryKey,serial"`
}
// Table name in database: "user_profile" (automatic conversion)
```

### Multiple Directives

```go
// This is a regular comment
// table_name: products_inventory
// Another comment
type Product struct {
    ID int `po:"id,primaryKey,serial"`
}
// Table name in database: "products_inventory"
```

## Use Cases

1. **Legacy Database Compatibility**: Map to existing tables with non-standard names
2. **Plural Table Names**: Use `users` instead of `user`
3. **Custom Naming Conventions**: Follow your team's specific naming standards
4. **Complex Names**: Use names that don't match Go struct naming conventions

## How It Works

### Development (Source Files Available)

1. **Source File Parsing**: Pebble ORM parses the Go source file at registration time
2. **Comment Extraction**: Looks for `table_name:` directive in comments above struct
3. **Fallback**: If no directive is found, uses default `snake_case` conversion

### Production (Docker Builds)

Comment directives require source files at runtime, which don't exist in production Docker builds.

**Solution**: Use CLI to generate metadata before building:

```bash
# Generate table name metadata from comments
pebble generate metadata --scan ./internal/models
```

This creates `internal/models/table_names.gen.go`:

```go
// Code generated by pebble-orm. DO NOT EDIT.

package models

import "github.com/marshallshelly/pebble-orm/pkg/schema"

func init() {
    // Register custom table names from comment directives
    schema.RegisterTableName("User", "custom_users_table")
    schema.RegisterTableName("Product", "products_inventory")
}
```

**Workflow:**

1. Write models with `// table_name:` comments (as before)
2. Run `pebble generate metadata --scan ./internal/models` before building
3. Commit the generated `table_names.gen.go` file
4. Build Docker image (generated code is compiled in)
5. âœ… Custom table names work in production!

**Add to Dockerfile:**

```dockerfile
FROM golang:1.21 AS builder
WORKDIR /app
COPY . .

# Install pebble CLI and generate metadata
RUN go install github.com/marshallshelly/pebble-orm/cmd/pebble@latest
RUN pebble generate metadata --scan ./internal/models

# Build
RUN go build -o app

FROM alpine:latest
COPY --from=builder /app/app /app
ENTRYPOINT ["/app"]
```

**Or commit the generated file** (recommended):

```bash
# Generate once, commit to git
pebble generate metadata --scan ./internal/models
git add internal/models/table_names.gen.go
git commit -m "Generate table name metadata"

# Docker build just works (no CLI needed)
docker build -t app .
```

## Running the Example

```bash
cd examples/custom_table_names
go run cmd/custom_tables/main.go
```

## Important Notes

- **Development**: Comment directives work directly from source files
- **Production**: Use `pebble generate metadata` to create compiled registrations
- Comment directive is read when you call `registry.Register(Model{})`
- If source file cannot be found, falls back to `snake_case` conversion
- Works with both single-file and multi-file packages
- Generated file should be committed to version control

## Migration Generation

When generating migrations, the custom table names will be used:

```bash
pebble generate --name add_custom_tables --db "postgres://..."
```

The generated migration will create tables with your custom names!

## Best Practice for Production

**Recommended workflow:**

```bash
# 1. Add/update models with comments
# // table_name: users
# type User struct { ... }

# 2. Generate metadata
pebble generate metadata --scan ./internal/models

# 3. Add to CI/CD to verify it's up to date
git diff --exit-code internal/models/table_names.gen.go || exit 1

# 4. Build normally
go build -o app
```

This ensures custom table names work reliably in all environments!
