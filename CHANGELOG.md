# Changelog

All notable changes to Pebble ORM will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

## [1.7.0] - 2025-12-28

### Added

- **PostgreSQL Identity Columns Support** - Added support for SQL standard` GENERATED AS IDENTITY` columns
  - **Modern Alternative to SERIAL**: Identity columns are the SQL:2003 standard for auto-incrementing IDs
  - **Two Generation Types**:
    - `identity` or `identityAlways` → `GENERATED ALWAYS AS IDENTITY` (strict, prevents manual override)
    - `identityByDefault` → `GENERATED BY DEFAULT AS IDENTITY` (flexible, allows manual values)
  - **Backward Compatible**: SERIAL columns still fully supported
  - **PostgreSQL 10+**: Requires PostgreSQL 10 or later

### Tag Syntax

```go
type User struct {
    // GENERATED ALWAYS AS IDENTITY (recommended)
    ID int64 `po:"id,primaryKey,bigint,identity"`

    // GENERATED BY DEFAULT AS IDENTITY
    OrderID int `po:"order_id,integer,identityByDefault"`

    // Legacy SERIAL (still works)
    LegacyID int `po:"legacy_id,serial"`
}
```

### Generated SQL

```sql
CREATE TABLE users (
    id bigint GENERATED ALWAYS AS IDENTITY,
    order_id integer GENERATED BY DEFAULT AS IDENTITY,
    legacy_id serial NOT NULL,
    CONSTRAINT users_pkey PRIMARY KEY (id)
);
```

### Implementation Details

**Schema Metadata:**

- Added `Identity *IdentityColumn` field to `ColumnMetadata`
- New types: `IdentityColumn`, `IdentityGeneration` (ALWAYS | BY DEFAULT)

**Parser:**

- Recognizes `identity`, `identityAlways`, `identityByDefault` tags
- Identity columns automatically NOT NULL (per PostgreSQL spec)

**Migration Planner:**

- Generates `GENERATED {ALWAYS|BY DEFAULT} AS IDENTITY` syntax
- Proper handling in CREATE TABLE statements

**Testing:**

- Comprehensive test coverage in `pkg/schema/identity_test.go`
- Migration generation tests in `pkg/migration/identity_test.go`
- Example documentation in `examples/identity-columns/`

### Benefits

- ✅ **SQL Standard** - Portable, future-proof
- ✅ **Better Safety** - `ALWAYS` prevents accidental manual IDs
- ✅ **Cleaner** - No implicit sequence creation
- ✅ **Modern** - PostgreSQL documentation recommends over SERIAL
- ✅ **Backward Compatible** - Doesn't break existing SERIAL columns

### References

- [PostgreSQL Documentation: Identity Columns](https://www.postgresql.org/docs/current/ddl-identity-columns.html)
- Example: `examples/identity-columns/README.md`

## [1.6.1] - 2025-12-27

### Fixed

- **Critical: Serial Column DROP DEFAULT Bug** - Fixed auto-migration incorrectly generating `DROP DEFAULT` for serial columns
  - **Problem**: When comparing code schema (serial) vs database schema (integer with nextval), differ saw these as different defaults
  - **Impact**: Auto-increment functionality broken after migration, causing `NOT NULL` constraint violations on INSERT
  - **Root Cause**: Differ didn't recognize that `serial` in code === `DEFAULT nextval('table_id_seq'::regclass)` in database
  - **Solution**: Added special handling to detect and preserve sequence-based defaults for serial/autoincrement columns
  - **Affects**: Runtime auto-migration (`initSchemaWithMigrations`), not file-based migrations

### Technical Details

The differ now recognizes these as equivalent (no migration generated):

```go
// Code schema
type Model struct {
    ID int `po:"id,primaryKey,serial"`
}

// Database schema
CREATE TABLE model (
    id INTEGER NOT NULL DEFAULT nextval('model_id_seq'::regclass)
);
```

**New Helper Methods:**

- `isSameDefaultWithSerial()` - Compares defaults with serial column awareness
- `isAutoIncrementColumn()` - Detects serial/bigserial/smallserial types
- `isSequenceDefault()` - Identifies PostgreSQL sequence defaults (nextval patterns)

**Test Coverage:**

- Serial, bigserial, smallserial variations
- Different nextval() formats (with/without regclass, quoted names, uppercase)
- Ensures legitimate default changes still detected
- Comprehensive test suite: `pkg/migration/serial_default_test.go`

## [1.6.0] - 2025-12-27

### Added

- **CLI Migration Generation from Source Files**: Generate migrations directly from Go source files without requiring a database connection

  - `pebble generate --name migration_name --models ./path/to/models`
  - No `--db` flag required for initial migrations
  - Scans `.go` files and builds schema from struct tags
  - Supports both single files and directories
  - Respects custom table names from `// table_name:` comments
  - Generates complete CREATE TABLE statements with all constraints

- **AST-Based Schema Building**: New loader package that parses Go source files

  - Direct `TableMetadata` construction from AST
  - Extracts columns, types, constraints from struct tags
  - Handles primary keys, unique indexes, defaults
  - No reflection or runtime type information needed

- **Registry.RegisterMetadata()**: New method for direct `TableMetadata` registration
  - Allows CLI tools to register schemas without Go types
  - Bypasses the need for actual struct instances
  - Enables migration generation from source code alone

### Changed

- **`--db` Flag Now Optional**: Database connection only required when comparing with existing schema

  - Without `--db`: Generates initial migration (treats DB as empty)
  - With `--db`: Generates diff-based migration (compares code vs database)
  - Makes initial project setup easier

- **Migration Workflow Simplified**:

  ```bash
  # Step 1: Define models in Go
  # Step 2: Generate migration (no database needed!)
  pebble generate --name initial_schema --models ./internal/models

  # Step 3: Apply migration
  pebble migrate up --db "postgres://..."
  ```

### Benefits

- ✅ **No Database Required**: Generate migrations before database even exists
- ✅ **Source of Truth**: Go structs define schema, CLI generates SQL
- ✅ **Faster Development**: No need to manually write CREATE TABLE statements
- ✅ **Custom Table Names**: Automatically extracts from comments
- ✅ **Type Safe**: Generates SQL from strongly-typed Go definitions

## [1.5.3] - 2025-12-23

### Fixed

- **Serial Type in Migrations**: Fixed critical bug where migration planner generated invalid `ALTER COLUMN TYPE serial` SQL
  - **Problem**: `serial` is a PostgreSQL pseudotype that only works in `CREATE TABLE`, not `ALTER TABLE`
  - **Root Cause**: Differ compared `serial` (from code) vs `integer` (from database introspection) as different types
  - **Impact**: Migrations failed with `ERROR: type "serial" does not exist (SQLSTATE 42704)`
  - **Solution**: Map `serial` types to their underlying base types in type normalization
    - `serial` / `serial4` → `integer`
    - `bigserial` / `serial8` → `bigint`
    - `smallserial` / `serial2` → `smallint`
  - Now correctly recognizes that `serial` in code equals `integer` in database (no type change)
  - Never generates `ALTER COLUMN TYPE serial` (uses `integer` instead)

### Technical Details

PostgreSQL serial types are syntactic sugar:

```sql
-- What you write:
CREATE TABLE users (id serial PRIMARY KEY);

-- What PostgreSQL creates:
CREATE SEQUENCE users_id_seq;
CREATE TABLE users (
    id integer NOT NULL DEFAULT nextval('users_id_seq'),
    PRIMARY KEY (id)
);
```

Since `serial` is not a real type, `ALTER TABLE ... TYPE serial` fails. The differ now treats:

- Code: `serial` ≡ Database: `integer` (no diff)
- This prevents invalid ALTER statements

### Testing

Added comprehensive test suite (`pkg/migration/serial_test.go`):

- `TestSerialTypesMapToInteger` - Validates type equivalence
- `TestSerialDoesNotTriggerTypeChange` - Ensures no false type diffs
- `TestBigSerialMapping` - Tests bigserial ↔ bigint
- All existing migration tests pass

## [1.5.2] - 2025-12-23

### Added

- **CLI Metadata Generation**: Production-safe solution for custom table names via code generation
  ```bash
  pebble generate metadata --scan ./internal/models
  ```
  - Scans source files for `// table_name:` comment directives
  - Generates `table_names.gen.go` with compile-time registrations
  - Generated code is committed to version control
  - Works in production Docker builds (no runtime source file dependency)

### Fixed

- **Production Build Support**: v1.5.1's comment parsing requires source files at runtime
  - Problem: Multi-stage Docker builds only copy compiled binary, not `.go` files
  - Impact: Custom table names fail in production, fall back to wrong snake_case names
  - Solution: CLI generates code that registers table names at compile-time

### Changed

- **Table Name Resolution Priority**:
  1. Global registry (populated by generated code from `pebble generate metadata`)
  2. Comment directives (development only, when source files exist)
  3. snake_case fallback (default)

### Workflow

```bash
# 1. Write models with comments (as before)
# // table_name: tenants
# type Tenant struct { ... }

# 2. Generate metadata before building
pebble generate metadata --scan ./api/models

# 3. Commit generated file
git add ./api/models/table_names.gen.go

# 4. Build Docker (generated code is included)
docker build -t app:latest .

# ✅ Custom table names work in production!
```

### Why This Approach

- ✅ **Zero boilerplate** in model files
- ✅ **Comments still work** - no API changes
- ✅ **CLI-driven** - fits existing workflow
- ✅ **Production-safe** - works in Docker
- ✅ **One command** - `pebble generate metadata`

## [1.5.1] - 2025-12-23

### Fixed

- **table_name Comment Directive**: Fixed critical bug where `// table_name: custom_name` comments were not being parsed
  - Issue: Models registered with custom table names were falling back to default snake_case conversion
  - Root Cause: `findSourceFile()` function couldn't locate source files for main package or models outside GOPATH
  - Solution: Enhanced source file search to prioritize current working directory
  - Impact: Custom table names now work correctly for migrations and queries
  - Affected: Model registration, schema parsing, migration generation

### Changes

- Updated `pkg/schema/parser.go`:
  - `findSourceFile()` now searches current working directory first
  - Properly handles `main` package models
  - Works with models defined anywhere in the filesystem
- Updated tests to expect correct custom table names instead of fallback values

## [1.5.0] - 2025-12-23

### Added

- **PostgreSQL Generated Columns**: Full support for `GENERATED ALWAYS AS` columns
  - `STORED` generated columns (computed on INSERT/UPDATE)
  - `VIRTUAL` type reserved for future PostgreSQL support
  - Tag syntax: `po:"column_name,generated:EXPRESSION,stored"`
  - Automatic SQL generation: `GENERATED ALWAYS AS (expression) STORED`
  - Comprehensive test coverage

### Features

- **Automatic Computation**: Database computes values from other columns
- **Type-Safe**: Defined in Go structs with struct tags
- **Migration Support**: Generates correct DDL automatically
- **Read-Only**: Generated columns cannot be manually set
- **Indexable**: Can create indexes on generated columns

### Examples

```go
type Person struct {
    FirstName string `po:"first_name"`
    LastName  string `po:"last_name"`
    FullName  string `po:"full_name,generated:first_name || ' ' || last_name,stored"`
}
```

### Documentation

- Added comprehensive generated columns example
- Updated parser to support colon format (`key:value`)
- Added tests for schema parsing and SQL generation

## [1.4.0] - 2025-12-23

### Added

- **Safe Auto-Migrations**: Migrations are now idempotent by default
  - `CREATE TABLE IF NOT EXISTS` instead of `CREATE TABLE`
  - `CREATE INDEX IF NOT EXISTS` for all indexes
  - Safe to run migrations multiple times without errors
  - Configurable via `PlannerOptions.IfNotExists` (default: `true`)
  - New `NewPlannerWithOptions()` for custom migration behavior

### Benefits

- ✅ Applications can restart without migration errors
- ✅ Deployments are more robust
- ✅ No manual error handling needed
- ✅ Aligns with database migration best practices

### Changed

- **Migration Planner**: Now uses `PlannerOptions` struct for configuration
- **Default Behavior**: All migrations include `IF NOT EXISTS` (safe by default)

### Documentation

- Added comprehensive test coverage for `PlannerOptions`
- Updated all migration tests to expect `IF NOT EXISTS`

## [1.3.1] - 2025-12-22

### Documentation

- **Example Updates**: Updated `transactions` and `relationships` examples to use `builder.Col`
  - Replaced hardcoded string literals with type-safe column references
  - Ensures consistency with v1.3.0 features
  - Fixed linting warnings in example code

## [1.3.0] - 2025-12-22

### ⚠️ BREAKING CHANGES

- **Tag Naming**: Foreign key constraint tags now use camelCase for consistency
  - Changed: `ondelete:` → `onDelete:`
  - Changed: `onupdate:` → `onUpdate:`
  - **Migration**: Run `sed -i 's/ondelete:/onDelete:/g' **/*.go` and `sed -i 's/onupdate:/onUpdate:/g' **/*.go`
  - Reason: Matches existing camelCase convention (`notNull`, `primaryKey`, `autoIncrement`, etc.)

### Added

- **Type-Safe Column Names**: `builder.Col[T](fieldName)` helper (from v1.2.1)
  - Single source of truth through struct tag metadata
  - Compile-time type safety with Go generics
  - IDE autocomplete support
- **pkg.go.dev Badge**: Official documentation badge

### Changed

- **Tag Consistency**: All struct tag options now use camelCase
- **Integration Tests**: Use ORM's migration system (validates ORM features)
- **Builder API**: Consistent `builder.Select[T](qb)` pattern throughout

### Fixed

- Tag naming inconsistency across foreign key constraints
- GoReleaser deprecation warnings
- Integration test compilation

## [1.2.1] - 2025-12-22

### Added

- **Type-Safe Column Names**: New `builder.Col[T](fieldName)` helper for single source of truth
  - Extracts database column names from struct tag metadata
  - Eliminates hardcoded string literals in queries
  - Provides compile-time type safety with Go generics
  - Zero runtime overhead via registry lookup
  - IDE-friendly with autocomplete support
- **pkg.go.dev Badge**: Added official Go package documentation badge to README

### Changed

- **Integration Tests**: Now use Pebble ORM's migration system instead of raw SQL
  - Tests schema introspection, diffing, and SQL generation
  - Validates ORM's own migration capabilities
  - Demonstrates real-world migration usage
- **Builder API**: Updated all examples to use `builder.Select[T](qb)` pattern
  - Consistent API across all operations
  - Removed legacy `db.Insert(T{})` patterns
- **Documentation**: Comprehensive updates across all files
  - README.md: Quick start with `builder.Col`
  - CLAUDE.md: All query examples use type-safe column names
  - examples/README.md: New "Type-Safe Column Names" section
  - examples/basic: Live demonstration of `builder.Col`

### Fixed

- GoReleaser configuration deprecation warnings
- Removed non-existent Homebrew tap from release config
- Integration test compilation with new builder API
- Removed unused `toTyped` helper function

### Documentation

- Added MIT LICENSE file
- Enhanced examples README with builder.Col best practices
- Updated all code examples to demonstrate single source of truth
- Added benefits table and problem/solution comparison

## [1.1.0] - 2025-01-XX

project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [1.0.0] - 2025-12-22

### Added

#### Core Features

- Type-safe query builder using Go 1.21+ generics
- Zero-overhead performance with native pgx integration
- Struct-tag based schema definitions
- Automatic migration generation and management
- Full relationship support (hasMany, hasOne, belongsTo, manyToMany)
- CASCADE DELETE via foreign key constraint tags
- Transaction support with proper error handling

#### PostgreSQL Features

- JSONB support for flexible JSON data
- Array types for multi-value columns
- UUID primary key support
- Geometric types (point, polygon, circle, etc.)
- Full-text search capabilities

#### Developer Experience

- Interactive CLI with TUI for migrations and introspection
- 7 comprehensive examples with production-ready structure
  - Basic CRUD operations
  - Custom table names
  - Relationships with eager loading
  - Transaction handling
  - Migration management
  - PostgreSQL-specific features
  - CASCADE DELETE examples
- Complete API documentation
- Integration tests with testcontainers

#### Architecture

- `pkg/builder`: Type-safe query builder
- `pkg/schema`: Schema parsing and type mapping
- `pkg/registry`: Model registration and caching
- `pkg/migration`: Migration system and introspection
- `pkg/runtime`: Database connection management
- `cmd/pebble`: Interactive CLI tool

### Documentation

- Comprehensive README with badges and examples
- Professional logo with transparent background
- Individual README files for all 7 examples
- Migration guide and best practices
- CI/CD workflows for testing and releases

### Infrastructure

- GitHub Actions CI workflow
- golangci-lint integration
- GoReleaser configuration for multi-platform releases
- Homebrew tap support

[1.0.0]: https://github.com/marshallshelly/pebble-orm/releases/tag/v1.0.0
